name: Update HURDAT2 Data

on:
  schedule:
    # Runs every Monday at 6am UTC
    - cron: '0 6 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Fetch Atlantic HURDAT2
        run: |
          # Download HTML and extract data between <pre> tags
          curl -sL "https://www.aoml.noaa.gov/hrd/hurdat/hurdat2.html" | \
            sed -n '/<pre>/,/<\/pre>/p' | \
            sed '1d;$d' > data/hurdat2-atlantic.txt
          
          echo "Atlantic data fetched: $(wc -l < data/hurdat2-atlantic.txt) lines"
          head -5 data/hurdat2-atlantic.txt
      
      - name: Fetch East Pacific HURDAT2
        run: |
          # Download HTML and extract data between <pre> tags
          curl -sL "https://www.aoml.noaa.gov/hrd/hurdat/hurdat2-nepac.html" | \
            sed -n '/<pre>/,/<\/pre>/p' | \
            sed '1d;$d' > data/hurdat2-pacific.txt
          
          echo "Pacific data fetched: $(wc -l < data/hurdat2-pacific.txt) lines"
          head -5 data/hurdat2-pacific.txt
      
      - name: Validate data
        run: |
          # Check that files have content and look like HURDAT2 format
          if [ ! -s data/hurdat2-atlantic.txt ]; then
            echo "ERROR: Atlantic data file is empty"
            exit 1
          fi
          
          if [ ! -s data/hurdat2-pacific.txt ]; then
            echo "ERROR: Pacific data file is empty"
            exit 1
          fi
          
          # Check for expected format (AL or EP/CP storm IDs)
          if ! grep -q "^AL" data/hurdat2-atlantic.txt; then
            echo "ERROR: Atlantic data doesn't contain expected AL storm IDs"
            exit 1
          fi
          
          if ! grep -qE "^(EP|CP)" data/hurdat2-pacific.txt; then
            echo "ERROR: Pacific data doesn't contain expected EP/CP storm IDs"
            exit 1
          fi
          
          echo "Data validation passed"
      
      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          
          # Check if there are staged changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update HURDAT2 data $(date +'%Y-%m-%d')"
            git push
            echo "Changes committed and pushed"
          fi
